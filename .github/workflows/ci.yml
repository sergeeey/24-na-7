name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Lint with ruff
      run: |
        ruff check src tests

    - name: Type check with mypy
      run: |
        mypy src --ignore-missing-imports

    - name: Run tests with coverage
      run: |
        pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml --json-report --json-report-file=tests/.report.json
    
    - name: Check coverage threshold
      run: |
        coverage report --fail-under=80 || (echo "Coverage is below 80%" && exit 1)
    
    - name: Update metrics from tests
      if: always()
      run: |
        python scripts/auto_measure.py --checklist .cursor/tasks/surpass_smart_noter_checklist.yaml --report tests/.report.json --dry-run
    
    - name: Security check (SAFE)
      run: |
        if [ -f ".cursor/validation/safe/run.py" ]; then
          python .cursor/validation/safe/run.py --mode audit || true
        fi
    
    - name: Security scan (Bandit)
      run: |
        pip install bandit
        bandit -r src -f json -o bandit-report.json || true
    
    - name: Security scan (Ruff security)
      run: |
        ruff check src --select S || true
    
    - name: Dependency security check (pip-audit)
      run: |
        pip install pip-audit
        pip-audit --desc || true
    
    - name: Dependency check (safety)
      run: |
        pip install safety
        safety check --json || true

    - name: Docker security scan (Trivy)
      if: always()
      run: |
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy:latest image reflexio-api:latest || true

  pr-gates:
    name: PR Quality Gates
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run PR Gate Checks
      id: pr-gates
      run: |
        python .github/scripts/pr_gate_checks.py

    - name: Comment PR Results
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');
          const checksPassed = ${{ steps.pr-gates.outcome == 'success' }};

          const header = checksPassed
            ? '## ✅ PR Quality Gates: PASSED'
            : '## ❌ PR Quality Gates: FAILED';

          const body = `${header}

          **Checks:**
          - Hallucination Rate: Target ≤0.5%
          - Citation Coverage: Target ≥98% (≥50% for mock mode)
          - Test Coverage: Target ≥80%
          - Unit Tests: All passing

          ${checksPassed ? '✅ All quality gates passed!' : '❌ Some checks failed. Review the logs above.'}

          <details>
          <summary>View detailed results</summary>

          See the "Run PR Gate Checks" step in the workflow logs for full output.
          </details>`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build API Docker image
      run: |
        docker build -f Dockerfile.api -t reflexio-api:latest .
      # NOTE: continue-on-error removed — build должен fail если tests failed

    - name: Build Worker Docker image
      run: |
        docker build -f Dockerfile.worker -t reflexio-worker:latest .
      # NOTE: continue-on-error removed — build должен fail если tests failed
