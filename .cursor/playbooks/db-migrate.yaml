name: db-migrate
version: 1.0
description: >
  –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: SQLite ‚Üí Supabase.
  –í—ã–ø–æ–ª–Ω—è–µ—Ç dry-run, backup, –º–∏–≥—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã –∏ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–≤–µ—Ä–∫—É.

parameters:
  - name: target
    default: "supabase"
    description: "–¶–µ–ª–µ–≤–æ–π –±—ç–∫–µ–Ω–¥: supabase | sqlite"
  - name: dry_run
    default: false
    description: "Dry run mode (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏)"
  - name: backup
    default: true
    description: "–°–æ–∑–¥–∞—Ç—å backup SQLite –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π"

steps:
  - name: Check prerequisites
    shell: bash
    run: |
      echo "[db-migrate] Checking prerequisites..."
      
      if [ "{{ target }}" == "supabase" ]; then
        if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ]; then
          echo "‚ùå Supabase credentials not set"
          exit 1
        fi
        echo "‚úÖ Supabase credentials found"
      fi
      
      if [ ! -f "src/storage/reflexio.db" ]; then
        echo "‚ö†Ô∏è  SQLite database not found, skipping data migration"
      else
        echo "‚úÖ SQLite database found"
      fi

  - name: Backup SQLite database
    shell: bash
    run: |
      if [ "{{ backup }}" == "true" ] && [ -f "src/storage/reflexio.db" ]; then
        echo "[db-migrate] Creating backup..."
        backup_file="src/storage/reflexio.db.backup.$(date +%Y%m%d_%H%M%S)"
        cp "src/storage/reflexio.db" "$backup_file"
        echo "‚úÖ Backup created: $backup_file"
      fi

  - name: Apply schema migrations
    shell: bash
    run: |
      echo "[db-migrate] Applying schema migrations..."
      python src/storage/migrate.py --to {{ target }} --apply-schema

  - name: Dry run data migration
    shell: bash
    run: |
      if [ "{{ dry_run }}" == "true" ]; then
        echo "[db-migrate] DRY RUN: Checking migration feasibility..."
        python src/storage/migrate.py --to {{ target }} --migrate-data --dry-run
      fi

  - name: Migrate data (if not dry run)
    shell: bash
    run: |
      if [ "{{ dry_run }}" == "false" ] && [ -f "src/storage/reflexio.db" ]; then
        echo "[db-migrate] Migrating data..."
        python src/storage/migrate.py --to {{ target }} --migrate-data
      else
        echo "‚è≠Ô∏è  Skipping data migration (dry_run={{ dry_run }})"
      fi

  - name: Verify row counts
    shell: bash
    run: |
      if [ "{{ target }}" == "supabase" ] && [ "{{ dry_run }}" == "false" ]; then
        echo "[db-migrate] Verifying row counts..."
        python src/storage/migrate.py --verify
      fi

  - name: Verify migration
    shell: bash
    run: |
      echo "[db-migrate] Verifying migration..."
      python - <<'PYCODE'
      import sys
      import json
      from pathlib import Path
      sys.path.insert(0, str(Path.cwd()))
      
      from src.storage.db import get_db_backend
      
      report = {
          "timestamp": __import__("datetime").datetime.utcnow().isoformat(),
          "tables": {},
          "status": "success"
      }
      
      try:
          backend = get_db_backend()
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã
          new_tables = ["missions", "claims", "audio_meta", "text_entries", "insights", "metrics"]
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
          old_tables = ["ingest_queue", "transcriptions", "facts", "digests"]
          
          all_tables = new_tables + old_tables
          
          for table in all_tables:
              try:
                  rows = backend.select(table, limit=10)
                  count = len(rows) if rows else 0
                  report["tables"][table] = {"accessible": True, "sample_count": count}
                  print(f"‚úÖ {table}: accessible (sample: {count} rows)")
              except Exception as e:
                  report["tables"][table] = {"accessible": False, "error": str(e)}
                  print(f"‚ö†Ô∏è  {table}: {e}")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á—ë—Ç
          report_path = Path(".cursor/audit/db_migration_report.json")
          report_path.parent.mkdir(parents=True, exist_ok=True)
          with open(report_path, "w") as f:
              json.dump(report, f, indent=2, ensure_ascii=False)
          
          print(f"‚úÖ Migration verification complete")
          print(f"üìÑ Report saved: {report_path}")
      except Exception as e:
          report["status"] = "failed"
          report["error"] = str(e)
          print(f"‚ùå Verification failed: {e}")
          sys.exit(1)
      PYCODE

  - name: Log completion
    run: |
      echo ""
      echo "‚úÖ Database migration complete"
      echo "üìÑ Report: .cursor/audit/db_migration_report.json"

