name: build-reflexio
version: 1.1
description: >
  ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Reflexio 24/7 (F1 Build).
  Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ, Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ·Ğ°Ğ¿ÑƒÑĞº API, smoke-Ñ‚ĞµÑÑ‚,
  Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¸ Ğ°ÑƒĞ´Ğ¸Ñ‚ CEB-E. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ ÑĞµÑ€Ğ²ĞµÑ€ Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹.

parameters:
  skip_tests: false
  force_reinstall: false
  api_port: 8000

steps:
  # ------------------------------------------------------------
  - name: Validate Environment
    shell: bash
    run: |
      set -e
      echo "[env] Python:" $(python --version)
      echo "[env] FFmpeg:" $(ffmpeg -version | head -1 || echo "not installed")
      pyver=$(python -c 'import sys; print(sys.version_info.minor)')
      if [ "$pyver" -lt 10 ]; then
        echo "[env] âŒ Python 3.10+ required"; exit 1
      fi
      echo "[env] âœ… Environment validated"

  # ------------------------------------------------------------
  - name: Prepare .env
    shell: bash
    run: |
      set -e
      [ -f .env ] || cp .env.example .env
      echo "[build-reflexio] .env ready"

  # ------------------------------------------------------------
  - name: Install Dependencies
    shell: bash
    run: |
      set -e
      if [ "{{ force_reinstall }}" = "true" ]; then pip install --upgrade pip; fi
      if [ -f pyproject.toml ]; then
        pip install -e ".[dev]"
      elif [ -f requirements.txt ]; then
        pip install -r requirements.txt
      fi
      if [ -f ".cursor/audit/requirements.txt" ]; then
        pip install -r .cursor/audit/requirements.txt
      fi
      echo "[deps] âœ… Installed successfully"

  # ------------------------------------------------------------
  - name: Initialize Database
    shell: bash
    run: |
      set -e
      if [ -f "scripts/db_init.py" ] && [ -f "schema.sql" ]; then
        python scripts/db_init.py schema.sql
        echo "[db] âœ… Schema applied"
      else
        echo "[db] âš ï¸  Schema files not found, skipping DB init"
      fi

  # ------------------------------------------------------------
  - name: Create Logs Directory
    shell: bash
    run: |
      set -e
      mkdir -p logs
      echo "[build] Logs directory ready"

  # ------------------------------------------------------------
  - name: Start API Server (background)
    shell: bash
    run: |
      set -e
      mkdir -p .cursor
      uvicorn src.api.main:app --host 127.0.0.1 --port {{ api_port }} --reload > logs/api.log 2>&1 &
      SERVER_PID=$!
      echo $SERVER_PID > .cursor/server.pid
      echo "[server] â³ Waiting for API startup..."
      for i in {1..10}; do
        if curl -sf http://127.0.0.1:{{ api_port }}/health > /dev/null; then
          echo "[server] âœ… Ready (PID $SERVER_PID)"; break
        fi
        sleep 1
      done

  # ------------------------------------------------------------
  - name: Smoke Ingest + ASR
    shell: bash
    run: |
      set -e
      if [ -f "scripts/smoke_ingest.py" ]; then
        python scripts/smoke_ingest.py --url http://127.0.0.1:{{ api_port }} --out sample_file_id.txt
        if [ -f "scripts/trigger_transcription.py" ]; then
          python scripts/trigger_transcription.py --url http://127.0.0.1:{{ api_port }} --in sample_file_id.txt
        fi
        echo "[smoke] âœ… Ingest + Transcription passed"
      else
        echo "[smoke] âš ï¸  Smoke test scripts not found, skipping"
      fi

  # ------------------------------------------------------------
  - name: Metrics Snapshot
    shell: bash
    run: |
      set -e
      if [ -f "scripts/metrics_snapshot.py" ]; then
        python scripts/metrics_snapshot.py
        echo "[metrics] âœ… Snapshot written"
      else
        echo "[metrics] âš ï¸  Metrics script not found, skipping"
      fi

  # ------------------------------------------------------------
  - name: Run Tests
    shell: bash
    when: "{{ skip_tests }}" == "false"
    run: |
      set -e
      echo "[tests] Running pytest..."
      pytest -q --disable-warnings || { echo "[tests] âŒ Failed"; exit 1; }
      echo "[tests] âœ… Passed"

  # ------------------------------------------------------------
  - name: Run CEB-E Standard Audit
    command: "@playbook audit-standard"

  # ------------------------------------------------------------
  - name: Stop API Server
    shell: bash
    run: |
      set -e
      if [ -f .cursor/server.pid ]; then
        kill $(cat .cursor/server.pid) 2>/dev/null || true
        rm -f .cursor/server.pid
        echo "[server] ğŸ›‘ Stopped"
      fi

  # ------------------------------------------------------------
  - name: Summary
    shell: bash
    run: |
      echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Reflexio 24/7 Build Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      echo "âœ… Environment & deps installed"
      echo "âœ… API smoke tested"
      echo "âœ… Metrics saved to cursor-metrics.json"
      echo "âœ… Audit report: .cursor/audit/audit_report.md"
      echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      echo "Reflexio 24/7 Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ CEB-E v1.0 Level 5"













