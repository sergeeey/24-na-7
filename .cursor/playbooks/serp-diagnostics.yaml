name: serp-diagnostics
version: 1.0
description: >
  –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ SERP API ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º (Google, Bing, Yahoo)
  —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ –∑–æ–Ω—ã Bright Data. –°–æ–∑–¥–∞—ë—Ç –æ—Ç—á—ë—Ç —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∑–æ–Ω –ø–æ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏,
  —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

parameters:
  - name: output_dir
    default: ".cursor/audit"
    description: "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á—ë—Ç–æ–≤"

steps:
  # ------------------------------------------------------------
  - name: Check Environment Variables
    shell: bash
    run: |
      set -e
      echo "[serp-diagnostics] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
      
      python - <<'PYCODE'
      import os
      
      api_key = os.getenv("BRIGHTDATA_API_KEY")
      
      if not api_key:
          print("‚ùå BRIGHTDATA_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")
          print("   SERP API —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á (–Ω–µ proxy)")
          exit(1)
      else:
          print(f"‚úÖ BRIGHTDATA_API_KEY –Ω–∞–π–¥–µ–Ω")
      PYCODE

  # ------------------------------------------------------------
  - name: Check Zones Configuration
    shell: bash
    run: |
      set -e
      echo "[serp-diagnostics] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–æ–Ω..."
      
      python - <<'PYCODE'
      import json
      from pathlib import Path
      
      zones_file = Path(".cursor/config/brightdata_zones.json")
      
      if not zones_file.exists():
          print("‚ö†Ô∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
          print("   –°–æ–∑–¥–∞—ë—Ç—Å—è –±–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è...")
          zones_file.parent.mkdir(parents=True, exist_ok=True)
          
          default_config = {
              "zones": {
                  "serp_api1": {
                      "name": "SERP API Zone 1",
                      "type": "serp",
                      "engines": ["google", "bing"],
                      "priority": 1,
                      "rotation_enabled": True,
                  }
              },
              "rotation": {
                  "enabled": True,
                  "method": "round_robin",
              }
          }
          
          with open(zones_file, "w", encoding="utf-8") as f:
              json.dump(default_config, f, indent=2, ensure_ascii=False)
          
          print(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: {zones_file}")
      else:
          with open(zones_file, "r", encoding="utf-8") as f:
              config = json.load(f)
          
          zones = config.get("zones", {})
          serp_zones = [name for name, cfg in zones.items() if cfg.get("type") == "serp"]
          
          print(f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–æ–Ω –Ω–∞–π–¥–µ–Ω–∞")
          print(f"   –í—Å–µ–≥–æ –∑–æ–Ω: {len(zones)}")
          print(f"   SERP –∑–æ–Ω: {len(serp_zones)}")
          
          if serp_zones:
              print(f"   –ó–æ–Ω—ã: {', '.join(serp_zones)}")
          else:
              print("‚ö†Ô∏è  SERP –∑–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
      PYCODE

  # ------------------------------------------------------------
  - name: Run SERP Diagnostics
    shell: bash
    run: |
      set -e
      echo "[serp-diagnostics] –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ SERP..."
      
      python scripts/serp_diagnostics.py \
        --output-json {{ output_dir }}/serp_diagnostics.json \
        --output-markdown {{ output_dir }}/serp_diagnostics.md

  # ------------------------------------------------------------
  - name: Check Diagnostics Results
    shell: bash
    run: |
      set -e
      echo "[serp-diagnostics] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
      
      python - <<'PYCODE'
      import json
      from pathlib import Path
      
      report_file = Path("{{ output_dir }}/serp_diagnostics.json")
      
      if report_file.exists():
          data = json.loads(report_file.read_text(encoding="utf-8"))
          summary = data.get("summary", {})
          rankings = data.get("rankings", {})
          
          print(f"\nSERP Diagnostics Results:")
          print(f"  Zones Tested: {summary.get('zones_tested', 0)}")
          print(f"  Healthy: {summary.get('zones_healthy', 0)}")
          print(f"  Degraded: {summary.get('zones_degraded', 0)}")
          print(f"  Unhealthy: {summary.get('zones_unhealthy', 0)}")
          
          if rankings.get("by_latency"):
              best = rankings["by_latency"][0]
              print(f"\nüèÜ Best Zone: {best['zone']} ({best['latency_ms']}ms)")
          
          if summary.get("zones_unhealthy", 0) > 0:
              print("\n‚ö†Ô∏è  Some zones are unhealthy - check the report")
          else:
              print("\n‚úÖ All SERP zones are healthy!")
      else:
          print("‚ùå Diagnostics report not found")
          exit(1)
      PYCODE

  # ------------------------------------------------------------
  - name: Update Metrics
    shell: bash
    run: |
      set -e
      echo "[serp-diagnostics] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫..."
      
      python - <<'PYCODE'
      import json
      from pathlib import Path
      from datetime import datetime, timezone
      
      # –û–±–Ω–æ–≤–ª—è–µ–º cursor-metrics.json —Å SERP –º–µ—Ç—Ä–∏–∫–∞–º–∏
      metrics_file = Path("cursor-metrics.json")
      diagnostics_file = Path("{{ output_dir }}/serp_diagnostics.json")
      
      if diagnostics_file.exists():
          diagnostics = json.loads(diagnostics_file.read_text(encoding="utf-8"))
          
          if metrics_file.exists():
              metrics = json.loads(metrics_file.read_text(encoding="utf-8"))
          else:
              metrics = {"metrics": {}}
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ SERP
          if "osint" not in metrics["metrics"]:
              metrics["metrics"]["osint"] = {}
          
          summary = diagnostics.get("summary", {})
          rankings = diagnostics.get("rankings", {})
          
          metrics["metrics"]["osint"]["serp_zones_tested"] = summary.get("zones_tested", 0)
          metrics["metrics"]["osint"]["serp_zones_healthy"] = summary.get("zones_healthy", 0)
          metrics["metrics"]["osint"]["serp_last_diagnostics"] = datetime.now(timezone.utc).isoformat()
          
          if rankings.get("by_latency"):
              best = rankings["by_latency"][0]
              metrics["metrics"]["osint"]["serp_best_zone"] = best["zone"]
              metrics["metrics"]["osint"]["serp_best_latency_ms"] = best["latency_ms"]
          
          metrics_file.write_text(
              json.dumps(metrics, indent=2, ensure_ascii=False),
              encoding="utf-8"
          )
          
          print("[serp-diagnostics] ‚úÖ Metrics updated")
      PYCODE

  # ------------------------------------------------------------
  - name: Summary
    shell: bash
    run: |
      echo ""
      echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SERP Diagnostics Complete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
      echo ""
      echo "Reports:"
      echo "  - {{ output_dir }}/serp_diagnostics.json"
      echo "  - {{ output_dir }}/serp_diagnostics.md"
      echo ""
      echo "Use the Markdown report to review zone rankings:"
      echo "  - Fastest zones (by latency)"
      echo "  - Most reliable zones (by success rate)"
      echo "  - Most productive zones (by results count)"
      echo ""
      echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"













