name: validate-mcp-config
version: 1.0
description: >
  –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MCP ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã .cursor/mcp.json,
  –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ URL/command –¥–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
  –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫. –°–æ–∑–¥–∞—ë—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.

parameters:
  - name: config_file
    default: ".cursor/mcp.json"
    description: "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MCP"
  - name: output_dir
    default: ".cursor/audit"
    description: "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á—ë—Ç–æ–≤"
  - name: fail_on_errors
    default: false
    description: "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å –æ—à–∏–±–∫–æ–π –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º"

steps:
  # ------------------------------------------------------------
  - name: Check Config File Exists
    shell: bash
    run: |
      set -e
      echo "[validate-mcp-config] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
      
      if [ ! -f "{{ config_file }}" ]; then
        echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: {{ config_file }}"
        exit 1
      else
        echo "‚úÖ –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω: {{ config_file }}"
      fi

  # ------------------------------------------------------------
  - name: Validate MCP Configuration
    shell: bash
    run: |
      set -e
      echo "[validate-mcp-config] –ó–∞–ø—É—Å–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MCP..."
      
      python scripts/validate_mcp_config.py \
        --config {{ config_file }} \
        --output-json {{ output_dir }}/mcp_config_validation.json \
        --output-markdown {{ output_dir }}/mcp_config_validation.md \
        {{ '--fail-on-errors' if fail_on_errors else '' }}

  # ------------------------------------------------------------
  - name: Check Environment Variables
    shell: bash
    run: |
      set -e
      echo "[validate-mcp-config] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
      
      python - <<'PYCODE'
      import json
      import os
      from pathlib import Path
      
      config_file = Path("{{ config_file }}")
      
      if not config_file.exists():
          print("‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω")
          exit(1)
      
      config = json.loads(config_file.read_text(encoding="utf-8"))
      servers = config.get("mcpServers", {})
      
      missing_vars = []
      
      for server_name, server_config in servers.items():
          if isinstance(server_config, dict):
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º api_key_env
              if "api_key_env" in server_config:
                  env_var = server_config["api_key_env"]
                  if not os.getenv(env_var):
                      missing_vars.append({
                          "server": server_name,
                          "env_var": env_var,
                      })
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º env —Å–µ–∫—Ü–∏—é
              if "env" in server_config:
                  for env_key, env_value in server_config["env"].items():
                      # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç ${}, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                      if isinstance(env_value, str) and env_value.startswith("${"):
                          var_name = env_value[2:-1]
                          if not os.getenv(var_name):
                              missing_vars.append({
                                  "server": server_name,
                                  "env_var": var_name,
                              })
      
      if missing_vars:
          print("‚ö†Ô∏è  –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
          for item in missing_vars:
              print(f"  [{item['server']}] {item['env_var']}")
          print()
          print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ .env")
      else:
          print("‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
      PYCODE

  # ------------------------------------------------------------
  - name: Verify Server Accessibility
    shell: bash
    run: |
      set -e
      echo "[validate-mcp-config] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤..."
      
      python - <<'PYCODE'
      import json
      import os
      import sys
      from pathlib import Path
      
      config_file = Path("{{ config_file }}")
      config = json.loads(config_file.read_text(encoding="utf-8"))
      servers = config.get("mcpServers", {})
      
      enabled_servers = [
          (name, cfg) for name, cfg in servers.items()
          if isinstance(cfg, dict) and cfg.get("enabled", False)
      ]
      
      print(f"–ù–∞–π–¥–µ–Ω–æ –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤: {len(enabled_servers)}")
      print()
      
      for server_name, server_config in enabled_servers:
          print(f"üîç [{server_name}]")
          
          if "url" in server_config:
              url = server_config["url"]
              print(f"   Type: URL-based")
              print(f"   URL: {url}")
          
          if "command" in server_config:
              command = server_config["command"]
              args = server_config.get("args", [])
              print(f"   Type: Command-based")
              print(f"   Command: {command} {' '.join(args[:2])}...")
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–µ–π
          if "api_key_env" in server_config:
              env_var = server_config["api_key_env"]
              if os.getenv(env_var):
                  key_preview = os.getenv(env_var)[:8] + "..." if len(os.getenv(env_var)) > 8 else "***"
                  print(f"   API Key: ‚úÖ ({key_preview})")
              else:
                  print(f"   API Key: ‚ùå ({env_var} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)")
          
          print()
      
      print("‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
      PYCODE

  # ------------------------------------------------------------
  - name: Generate Summary
    shell: bash
    run: |
      set -e
      echo "[validate-mcp-config] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ä–µ–∑—é–º–µ..."
      
      python - <<'PYCODE'
      import json
      from pathlib import Path
      
      report_file = Path("{{ output_dir }}/mcp_config_validation.json")
      
      if report_file.exists():
          results = json.loads(report_file.read_text(encoding="utf-8"))
          
          print("\n" + "=" * 70)
          print("MCP Configuration Validation Summary")
          print("=" * 70)
          print()
          print(f"Valid: {'‚úÖ Yes' if results['valid'] else '‚ùå No'}")
          print(f"Errors: {results['summary']['errors']}")
          print(f"Warnings: {results['summary']['warnings']}")
          print(f"Info: {results['summary']['info']}")
          print()
          
          if results['valid']:
              print("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MCP –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!")
          else:
              print("‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç—á—ë—Ç –¥–ª—è –¥–µ—Ç–∞–ª–µ–π")
              print()
              if results.get('errors'):
                  print("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:")
                  for error in results['errors'][:3]:
                      print(f"  - [{error['component']}] {error['message']}")
          
          print()
          print("Reports:")
          print(f"  - {{ output_dir }}/mcp_config_validation.json")
          print(f"  - {{ output_dir }}/mcp_config_validation.md")
          print("=" * 70)
      PYCODE

  # ------------------------------------------------------------
  - name: Update Metrics
    shell: bash
    run: |
      set -e
      echo "[validate-mcp-config] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫..."
      
      python - <<'PYCODE'
      import json
      from pathlib import Path
      from datetime import datetime, timezone
      
      metrics_file = Path("cursor-metrics.json")
      validation_file = Path("{{ output_dir }}/mcp_config_validation.json")
      
      if validation_file.exists():
          validation = json.loads(validation_file.read_text(encoding="utf-8"))
          
          if metrics_file.exists():
              metrics = json.loads(metrics_file.read_text(encoding="utf-8"))
          else:
              metrics = {"metrics": {}}
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ MCP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
          if "mcp" not in metrics["metrics"]:
              metrics["metrics"]["mcp"] = {}
          
          metrics["metrics"]["mcp"]["config_valid"] = validation["valid"]
          metrics["metrics"]["mcp"]["config_errors"] = validation["summary"]["errors"]
          metrics["metrics"]["mcp"]["config_warnings"] = validation["summary"]["warnings"]
          metrics["metrics"]["mcp"]["config_last_validation"] = datetime.now(timezone.utc).isoformat()
          
          metrics_file.write_text(
              json.dumps(metrics, indent=2, ensure_ascii=False),
              encoding="utf-8"
          )
          
          print("[validate-mcp-config] ‚úÖ Metrics updated")
      PYCODE

  # ------------------------------------------------------------
  - name: Final Summary
    shell: bash
    run: |
      echo ""
      echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MCP Config Validation Complete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
      echo ""
      echo "Reports:"
      echo "  - {{ output_dir }}/mcp_config_validation.json"
      echo "  - {{ output_dir }}/mcp_config_validation.md"
      echo ""
      echo "Next steps:"
      echo "  1. Review the Markdown report for detailed findings"
      echo "  2. Fix any errors reported"
      echo "  3. Reload Cursor window (Ctrl+Shift+P ‚Üí Developer: Reload Window)"
      echo "  4. Check MCP servers in Tools ‚Üí Installed MCP Servers"
      echo ""
      echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"












