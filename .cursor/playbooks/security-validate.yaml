name: security-validate
version: 1.0
description: >
  Запуск SAFE и CoVe валидации безопасности.
  Проверяет PII, секреты, домены, файлы, схемы данных.

parameters:
  - name: mode
    default: "audit"
    description: "Режим: strict (fail on errors) или audit (report only)"
  - name: output_dir
    default: ".cursor/audit/security"
    description: "Директория для сохранения отчётов"

steps:
  - name: Create output directory
    shell: bash
    run: |
      mkdir -p {{ output_dir }}

  - name: Run SAFE validation
    shell: bash
    run: |
      echo "[security-validate] Running SAFE checks..."
      python .cursor/validation/safe/run.py \
        --mode {{ mode }} \
        --output {{ output_dir }}/safe_report.json \
        --summary

  - name: Validate CoVe schemas
    shell: bash
    run: |
      echo "[security-validate] Validating CoVe schemas..."
      python - <<'PYCODE'
      import sys
      from pathlib import Path
      sys.path.insert(0, str(Path.cwd()))
      
      from .cursor.validation.cove.verify import CoVeVerifier
      import json
      
      # Тестовая валидация
      cove = CoVeVerifier()
      
      test_claim = {
          "text": "Test claim",
          "source_urls": ["https://example.com"],
          "confidence": 0.8,
          "extracted_at": "2025-11-03T12:00:00Z"
      }
      
      result = cove.verify_claim(test_claim)
      
      report = {
          "timestamp": __import__("datetime").datetime.utcnow().isoformat(),
          "claim_test": result
      }
      
      output_path = Path("{{ output_dir }}") / "cove_report.json"
      output_path.parent.mkdir(parents=True, exist_ok=True)
      with open(output_path, "w") as f:
          json.dump(report, f, indent=2)
      
      print(f"✅ CoVe validation completed: {result['valid']}")
      PYCODE

  - name: Generate security report
    shell: bash
    run: |
      echo "[security-validate] Generating combined report..."
      python - <<'PYCODE'
      import json
      from pathlib import Path
      from datetime import datetime
      
      output_dir = Path("{{ output_dir }}")
      safe_file = output_dir / "safe_report.json"
      cove_file = output_dir / "cove_report.json"
      
      report = {
          "timestamp": datetime.utcnow().isoformat(),
          "mode": "{{ mode }}",
          "safe": {},
          "cove": {},
          "summary": {
              "all_passed": True
          }
      }
      
      if safe_file.exists():
          report["safe"] = json.loads(safe_file.read_text())
          if report["safe"].get("summary", {}).get("failed", 0) > 0:
              report["summary"]["all_passed"] = False
      
      if cove_file.exists():
          report["cove"] = json.loads(cove_file.read_text())
          if not report["cove"].get("claim_test", {}).get("valid", True):
              report["summary"]["all_passed"] = False
      
      output_file = output_dir / "security_report.json"
      with open(output_file, "w") as f:
          json.dump(report, f, indent=2, ensure_ascii=False)
      
      print(f"✅ Security report saved: {output_file}")
      print(f"Summary: {'✅ PASSED' if report['summary']['all_passed'] else '❌ FAILED'}")
      PYCODE

  - name: Log completion
    run: |
      echo "✅ Security validation complete"











